"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var http_2 = require("@angular/http");
var _1 = require("rxjs/");
var AppointmentService = (function () {
    function AppointmentService(http) {
        this.http = http;
        this.url = "https://tools.brandinstitute.com/wsbi/bimobile.asmx/";
        this.urlGetAppointments = "getAppointments";
        this.urlSetGeoLocation = "addGeoLocation";
        this.getExpensesByAppId = "getExpensesByAppointmentId";
        this._appointments = new _1.BehaviorSubject([]);
        // private latitude = 25.773338;
        // private longitude = -80.190072;
        this.monthNames = ["Jan", "Febr", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];
        this._appointments = new _1.BehaviorSubject([]);
        this.appointments = this._appointments.asObservable();
    }
    AppointmentService.prototype.getAppointments = function (date) {
        var _this = this;
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('selDate', date);
        return this.http.post(this.url + this.urlGetAppointments, body.toString(), { headers: headers }).map(function (res) {
            var data = res.json();
            res.json().map(function (obj) {
                var dateTime = new Date(obj.AppDate);
                obj.AppDate = dateTime.getDate().toString() + ',' + _this.monthNames[dateTime.getMonth()].toString() + '-' +
                    +((dateTime.getHours() + 24 - 2) % 24).toString() + ':'
                    + dateTime.getMinutes().toString() + ((dateTime.getHours() >= 12) ? " PM" : " AM").toString();
            });
            return data;
        });
    };
    AppointmentService.prototype.getAppointmentLocation = function (appointmentAddress) {
        return this.http.get("http://maps.googleapis.com/maps/api/geocode/json?address=" + appointmentAddress).map(function (res) { return res.json(); });
    };
    AppointmentService.prototype.setGeoLocation = function (location, appointment) {
        var dateTime = new Date();
        var dateahora = dateTime.getFullYear().toString() + '-' + dateTime.getMonth().toString() + '-' + dateTime.getDate().toString() + ' ' +
            +dateTime.getHours().toString() + ':' + dateTime.getMinutes().toString() + ':' + dateTime.getSeconds().toString();
        var headers = new http_1.Headers();
        headers.append('Content-Type', 'application/x-www-form-urlencoded');
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('geoDate', dateahora);
        body.set('appId', appointment.AppId.toString());
        body.set('geoLatitude', location.latitude.toString());
        body.set('geoLongitude', location.longitude.toString());
        return this.http.post(this.url + 'addGeoLocation', body.toString(), { headers: headers }).map(function (res) { return res.json(); });
    };
    AppointmentService.prototype.saveExpense = function (appointment, imageBase64, recType, recTotal) {
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('appId', appointment.AppId.toString());
        // body.set('recType', recType);  use when real values in number come from dropdown
        body.set('recType', '1');
        body.set('recTotal', recTotal);
        body.set('imgType', 'base64');
        body.set('img', imageBase64);
        return this.http.post(this.url + 'addAppReceiptString', body.toString(), { headers: headers }).map(function (res) {
            res.json();
            imageBase64 = null;
        });
    };
    AppointmentService.prototype.getExpensesByAppointmentId = function (appid) {
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('appid', appid);
        return this.http.post(this.url + 'getExpensesByAppointmentId', body.toString(), { headers: headers }).map(function (res) { return res.json(); });
    };
    AppointmentService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http])
    ], AppointmentService);
    return AppointmentService;
}());
exports.AppointmentService = AppointmentService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcG9pbnRtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMEM7QUFDMUMsc0NBQXdEO0FBQ3hELHNDQUErQztBQUMvQywwQkFBb0Q7QUFRcEQ7SUFrQkksNEJBQW9CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO1FBakJ0QixRQUFHLEdBQUcsc0RBQXNELENBQUE7UUFDNUQsdUJBQWtCLEdBQUcsaUJBQWlCLENBQUE7UUFDdEMsc0JBQWlCLEdBQUcsZ0JBQWdCLENBQUE7UUFDcEMsdUJBQWtCLEdBQUcsNEJBQTRCLENBQUE7UUFJakQsa0JBQWEsR0FBbUMsSUFBSSxrQkFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBSWhGLGdDQUFnQztRQUNoQyxrQ0FBa0M7UUFDMUIsZUFBVSxHQUFHLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLO1lBQzNELEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSztTQUMzQyxDQUFDO1FBR0UsSUFBSSxDQUFDLGFBQWEsR0FBbUMsSUFBSSxrQkFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUMxRCxDQUFDO0lBRUQsNENBQWUsR0FBZixVQUFnQixJQUFZO1FBQTVCLGlCQWlCQztRQWhCRyxJQUFJLE9BQU8sR0FBRyxJQUFJLGNBQU8sQ0FBQyxFQUFFLGNBQWMsRUFBRSxtQ0FBbUMsRUFBRSxDQUFDLENBQUM7UUFDbkYsSUFBSSxJQUFJLEdBQUcsSUFBSSxzQkFBZSxFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLE9BQU8s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QUFDLElBQUksRUFBRSxFQUFWLENBQVUsQ0FBQyxDQUFDO0lBQ2pJLENBQUM7SUF6RlEsa0JBQWtCO1FBRDlCLGlCQUFVLEVBQUU7eUNBbUJpQixXQUFJO09BbEJyQixrQkFBa0IsQ0EyRjlCO0lBQUQseUJBQUM7Q0FBQSxBQTNGRCxJQTJGQztBQTNGWSxnREFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIlxuaW1wb3J0IHsgSHR0cCwgUmVzcG9uc2UsIEhlYWRlcnMgfSBmcm9tIFwiQGFuZ3VsYXIvaHR0cFwiO1xuaW1wb3J0IHsgVVJMU2VhcmNoUGFyYW1zIH0gZnJvbSBcIkBhbmd1bGFyL2h0dHBcIlxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy8nO1xuaW1wb3J0IHsgQXBwb2ludG1lbnQgfSBmcm9tIFwiLi9hcHBvaW50bWVudC5tb2RlbFwiO1xuXG5pbXBvcnQgKiBhcyBhcHBsaWNhdGlvbiBmcm9tICdhcHBsaWNhdGlvbidcbmltcG9ydCB7IExvb3BBcHBvaW50bWVudCB9IGZyb20gXCIuL2xvb3AvbG9vcC1hcHBvaW50bWVudC5tb2RlbFwiO1xuXG5kZWNsYXJlIGxldCBhbmRyb2lkOiBhbnlcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBcHBvaW50bWVudFNlcnZpY2Uge1xuICAgIHByaXZhdGUgdXJsID0gXCJodHRwczovL3Rvb2xzLmJyYW5kaW5zdGl0dXRlLmNvbS93c2JpL2JpbW9iaWxlLmFzbXgvXCJcbiAgICBwcml2YXRlIHVybEdldEFwcG9pbnRtZW50cyA9IFwiZ2V0QXBwb2ludG1lbnRzXCJcbiAgICBwcml2YXRlIHVybFNldEdlb0xvY2F0aW9uID0gXCJhZGRHZW9Mb2NhdGlvblwiXG4gICAgcHJpdmF0ZSBnZXRFeHBlbnNlc0J5QXBwSWQgPSBcImdldEV4cGVuc2VzQnlBcHBvaW50bWVudElkXCJcbiAgICBwcml2YXRlIHBob25lTnVtYmVyOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgICBwdWJsaWMgYXBwb2ludG1lbnRzOiBPYnNlcnZhYmxlPEFwcG9pbnRtZW50W10+O1xuICAgIHByaXZhdGUgX2FwcG9pbnRtZW50cyA9IDxCZWhhdmlvclN1YmplY3Q8QXBwb2ludG1lbnRbXT4+bmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gICAgcHJpdmF0ZSBkYXRhU3RvcmU6IHtcbiAgICAgICAgYXBwb2ludG1lbnRzOiBBcHBvaW50bWVudFtdXG4gICAgfTtcbiAgICAvLyBwcml2YXRlIGxhdGl0dWRlID0gMjUuNzczMzM4O1xuICAgIC8vIHByaXZhdGUgbG9uZ2l0dWRlID0gLTgwLjE5MDA3MjtcbiAgICBwcml2YXRlIG1vbnRoTmFtZXMgPSBbXCJKYW5cIiwgXCJGZWJyXCIsIFwiTWFyXCIsIFwiQXByXCIsIFwiTWF5XCIsIFwiSnVuXCIsXG4gICAgICAgIFwiSnVsXCIsIFwiQXVnXCIsIFwiU2VwXCIsIFwiT2N0XCIsIFwiTm92XCIsIFwiRGVjXCJcbiAgICBdO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwKSB7XG4gICAgICAgIHRoaXMuX2FwcG9pbnRtZW50cyA9IDxCZWhhdmlvclN1YmplY3Q8QXBwb2ludG1lbnRbXT4+bmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gICAgICAgIHRoaXMuYXBwb2ludG1lbnRzID0gdGhpcy5fYXBwb2ludG1lbnRzLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIGdldEFwcG9pbnRtZW50cyhkYXRlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFycmF5PEFwcG9pbnRtZW50Pj4ge1xuICAgICAgICBsZXQgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnIH0pO1xuICAgICAgICBsZXQgYm9keSA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWQnLCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncGhvbmVOdW1iZXInKSk7XG4gICAgICAgIGJvZHkuc2V0KCdwaG9uZUlkVHlwZScsIFwiMVwiKTtcbiAgICAgICAgYm9keS5zZXQoJ3NlbERhdGUnLCBkYXRlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy51cmwgKyB0aGlzLnVybEdldEFwcG9pbnRtZW50cywgYm9keS50b1N0cmluZygpLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSkubWFwKHJlcyA9PiB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IHJlcy5qc29uKCk7XG4gICAgICAgICAgICByZXMuanNvbigpLm1hcCgob2JqOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZGF0ZVRpbWUgPSBuZXcgRGF0ZShvYmouQXBwRGF0ZSk7XG4gICAgICAgICAgICAgICAgb2JqLkFwcERhdGUgPSBkYXRlVGltZS5nZXREYXRlKCkudG9TdHJpbmcoKSArICcsJyArIHRoaXMubW9udGhOYW1lc1tkYXRlVGltZS5nZXRNb250aCgpXS50b1N0cmluZygpICsgJy0nICtcbiAgICAgICAgICAgICAgICAgICAgKyAoKGRhdGVUaW1lLmdldEhvdXJzKCkgKyAyNCAtIDIpICUgMjQpLnRvU3RyaW5nKCkgKyAnOidcbiAgICAgICAgICAgICAgICAgICAgKyBkYXRlVGltZS5nZXRNaW51dGVzKCkudG9TdHJpbmcoKSArICgoZGF0ZVRpbWUuZ2V0SG91cnMoKSA+PSAxMikgPyBcIiBQTVwiIDogXCIgQU1cIikudG9TdHJpbmcoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgXG4gICAgZ2V0QXBwb2ludG1lbnRMb2NhdGlvbihhcHBvaW50bWVudEFkZHJlc3MpOiBPYnNlcnZhYmxlPEFycmF5PEFwcG9pbnRtZW50Pj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldChcImh0dHA6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL2dlb2NvZGUvanNvbj9hZGRyZXNzPVwiICsgYXBwb2ludG1lbnRBZGRyZXNzKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xuICAgIH1cblxuICAgIHNldEdlb0xvY2F0aW9uKGxvY2F0aW9uOiBhbnksIGFwcG9pbnRtZW50OiBBcHBvaW50bWVudCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIGxldCBkYXRlVGltZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGxldCBkYXRlYWhvcmEgPSBkYXRlVGltZS5nZXRGdWxsWWVhcigpLnRvU3RyaW5nKCkgKyAnLScgKyBkYXRlVGltZS5nZXRNb250aCgpLnRvU3RyaW5nKCkgKyAnLScgKyBkYXRlVGltZS5nZXREYXRlKCkudG9TdHJpbmcoKSArICcgJyArXG4gICAgICAgICAgICArIGRhdGVUaW1lLmdldEhvdXJzKCkudG9TdHJpbmcoKSArICc6JyArIGRhdGVUaW1lLmdldE1pbnV0ZXMoKS50b1N0cmluZygpICsgJzonICsgZGF0ZVRpbWUuZ2V0U2Vjb25kcygpLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgICBoZWFkZXJzLmFwcGVuZCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpO1xuICAgICAgICBjb25zdCBib2R5ID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpO1xuICAgICAgICBib2R5LnNldCgncGhvbmVJZCcsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdwaG9uZU51bWJlcicpKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWRUeXBlJywgXCIxXCIpO1xuICAgICAgICBib2R5LnNldCgnZ2VvRGF0ZScsIGRhdGVhaG9yYSk7XG4gICAgICAgIGJvZHkuc2V0KCdhcHBJZCcsIGFwcG9pbnRtZW50LkFwcElkLnRvU3RyaW5nKCkpO1xuICAgICAgICBib2R5LnNldCgnZ2VvTGF0aXR1ZGUnLCBsb2NhdGlvbi5sYXRpdHVkZS50b1N0cmluZygpKTtcbiAgICAgICAgYm9keS5zZXQoJ2dlb0xvbmdpdHVkZScsIGxvY2F0aW9uLmxvbmdpdHVkZS50b1N0cmluZygpKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy51cmwgKyAnYWRkR2VvTG9jYXRpb24nLCBib2R5LnRvU3RyaW5nKCksIHsgaGVhZGVyczogaGVhZGVycyB9KS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xuICAgIH1cblxuICAgIHNhdmVFeHBlbnNlKGFwcG9pbnRtZW50OiBBcHBvaW50bWVudCwgaW1hZ2VCYXNlNjQ6IGFueSwgcmVjVHlwZTogc3RyaW5nLCByZWNUb3RhbDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh7ICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyB9KTtcbiAgICAgICAgY29uc3QgYm9keSA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWQnLCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncGhvbmVOdW1iZXInKSk7XG4gICAgICAgIGJvZHkuc2V0KCdwaG9uZUlkVHlwZScsIFwiMVwiKTtcbiAgICAgICAgYm9keS5zZXQoJ2FwcElkJywgYXBwb2ludG1lbnQuQXBwSWQudG9TdHJpbmcoKSk7XG4gICAgICAgIC8vIGJvZHkuc2V0KCdyZWNUeXBlJywgcmVjVHlwZSk7ICB1c2Ugd2hlbiByZWFsIHZhbHVlcyBpbiBudW1iZXIgY29tZSBmcm9tIGRyb3Bkb3duXG4gICAgICAgIGJvZHkuc2V0KCdyZWNUeXBlJywgJzEnKTtcbiAgICAgICAgYm9keS5zZXQoJ3JlY1RvdGFsJywgcmVjVG90YWwpO1xuICAgICAgICBib2R5LnNldCgnaW1nVHlwZScsICdiYXNlNjQnKTtcbiAgICAgICAgYm9keS5zZXQoJ2ltZycsIGltYWdlQmFzZTY0KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHRoaXMudXJsICsgJ2FkZEFwcFJlY2VpcHRTdHJpbmcnLCBib2R5LnRvU3RyaW5nKCksIHsgaGVhZGVyczogaGVhZGVycyB9KS5tYXAocmVzID0+IHtcbiAgICAgICAgICAgIHJlcy5qc29uKCk7XG4gICAgICAgICAgICBpbWFnZUJhc2U2NCA9IG51bGw7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldEV4cGVuc2VzQnlBcHBvaW50bWVudElkKGFwcGlkOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh7ICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyB9KTtcbiAgICAgICAgbGV0IGJvZHkgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG4gICAgICAgIGJvZHkuc2V0KCdwaG9uZUlkJywgbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Bob25lTnVtYmVyJykpO1xuICAgICAgICBib2R5LnNldCgncGhvbmVJZFR5cGUnLCBcIjFcIik7XG4gICAgICAgIGJvZHkuc2V0KCdhcHBpZCcsIGFwcGlkKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHRoaXMudXJsICsgJ2dldEV4cGVuc2VzQnlBcHBvaW50bWVudElkJywgYm9keS50b1N0cmluZygpLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSkubWFwKHJlcyA9PiByZXMuanNvbigpKTtcbiAgICB9XG5cbn1cblxuIl19