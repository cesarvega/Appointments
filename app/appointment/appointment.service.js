"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var http_2 = require("@angular/http");
var _1 = require("rxjs/");
var Toast = require("nativescript-toast");
var AppointmentService = (function () {
    function AppointmentService(http) {
        this.http = http;
        this.url = "https://tools.brandinstitute.com/wsbi/bimobile.asmx/";
        this.urlGetAppointments = "getAppointments";
        this.urlSetGeoLocation = "addGeoLocation";
        this.getExpensesByAppId = "getExpensesByAppointmentId";
        this._appointments = new _1.BehaviorSubject([]);
        // private latitude = 25.773338;
        // private longitude = -80.190072;
        this.monthNames = ["Jan", "Febr", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];
        this._appointments = new _1.BehaviorSubject([]);
        this.appointments = this._appointments.asObservable();
    }
    AppointmentService.prototype.getAppointments = function (date) {
        var _this = this;
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('selDate', date);
        return this.http.post(this.url + this.urlGetAppointments, body.toString(), { headers: headers }).map(function (res) {
            var data = res.json();
            res.json().map(function (obj) {
                var dateTime = new Date(obj.AppDate);
                var hours = obj.AppDate.split('T')[1].toString();
                var time = hours.toString().match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/) || [obj.AppDate];
                if (time.length > 1) {
                    time = time.slice(1); // Remove full string match value
                    time[5] = +time[0] < 12 ? 'AM' : 'PM'; // Set AM/PM
                    time[0] = +time[0] % 12 || 12; // Adjust hours
                }
                var temp = dateTime.getDate().toString() + ',' + _this.monthNames[dateTime.getMonth()].toString() + '-' + time.join('');
                obj.AppDate = temp;
            });
            return data;
        });
    };
    AppointmentService.prototype.getAppointmentLocation = function (appointmentAddress) {
        return this.http.get("http://maps.googleapis.com/maps/api/geocode/json?address=" + appointmentAddress).map(function (res) { return res.json(); });
    };
    AppointmentService.prototype.setGeoLocation = function (location, appointment) {
        var dateTime = new Date();
        var dateahora = dateTime.getFullYear().toString() + '-' + (dateTime.getMonth() + 1).toString() + '-' + dateTime.getDate().toString() + ' ' +
            +dateTime.getHours().toString() + ':' + dateTime.getMinutes().toString() + ':' + dateTime.getSeconds().toString();
        var headers = new http_1.Headers();
        headers.append('Content-Type', 'application/x-www-form-urlencoded');
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('geoDate', dateahora);
        body.set('appId', appointment.AppId.toString());
        body.set('geoLatitude', location.latitude.toString());
        body.set('geoLongitude', location.longitude.toString());
        return this.http.post(this.url + 'addGeoLocation', body.toString(), { headers: headers }).map(function (res) { return res.json(); });
    };
    AppointmentService.prototype.saveExpense = function (appointment, imageBase64, recType, recTotal) {
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('appId', appointment.AppId.toString());
        // body.set('recType', recType);  use when real values in number come from dropdown
        body.set('recType', '1');
        body.set('recTotal', recTotal);
        body.set('imgType', 'base64');
        body.set('img', imageBase64);
        return this.http.post(this.url + 'addAppReceiptString', body.toString(), { headers: headers }).map(function (res) {
            res.json();
            imageBase64 = null;
        });
    };
    AppointmentService.prototype.getExpensesByAppointmentId = function (appid) {
        var headers = new http_1.Headers({ 'content-type': 'application/x-www-form-urlencoded' });
        var body = new http_2.URLSearchParams();
        body.set('phoneId', localStorage.getItem('phoneNumber'));
        body.set('phoneIdType', "1");
        body.set('appid', appid);
        return this.http.post(this.url + 'getExpensesByAppointmentId', body.toString(), { headers: headers }).map(function (res) { return res.json(); });
    };
    AppointmentService.prototype.testService = function () {
        android.nativeApp.IntentService.extend("com.tns.notifications.NotificationIntentService"
        /* give your class a valid name as it will need to be declared in the AndroidManifest later */ , {
            onHandleIntent: function (intent) {
                var action = intent.getAction();
                if ("ACTION_START" == action) {
                    // postNotification();
                    Toast.makeText("Action Started :)", "long").show();
                    var context = android.context;
                    var builder = new android.nativeApp.Notification.Builder(context);
                }
                else if ("ACTION_STOP" == action) {
                    /* get the system alarm manager and cancel all pending alarms, which will stop the service from executing periodically  */
                }
                android.context.support.v4.content.WakefulBroadcastReceiver.completeWakefulIntent(intent);
            }
        });
    };
    ;
    AppointmentService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http])
    ], AppointmentService);
    return AppointmentService;
}());
exports.AppointmentService = AppointmentService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImFwcG9pbnRtZW50LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMEM7QUFDMUMsc0NBQXdEO0FBQ3hELHNDQUErQztBQUMvQywwQkFBb0Q7QUFFcEQsMENBQTRDO0FBTTVDO0lBa0JJLDRCQUFvQixJQUFVO1FBQVYsU0FBSSxHQUFKLElBQUksQ0FBTTtRQWpCdEIsUUFBRyxHQUFHLHNEQUFzRCxDQUFBO1FBQzVELHVCQUFrQixHQUFHLGlCQUFpQixDQUFBO1FBQ3RDLHNCQUFpQixHQUFHLGdCQUFnQixDQUFBO1FBQ3BDLHVCQUFrQixHQUFHLDRCQUE0QixDQUFBO1FBSWpELGtCQUFhLEdBQW1DLElBQUksa0JBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUloRixnQ0FBZ0M7UUFDaEMsa0NBQWtDO1FBQzFCLGVBQVUsR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSztZQUMzRCxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUs7U0FDM0MsQ0FBQztRQUdFLElBQUksQ0FBQyxhQUFhLEdBQW1DLElBQUksa0JBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3RSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDMUQsQ0FBQztJQUVELDRDQUFlLEdBQWYsVUFBZ0IsSUFBWTtRQUE1QixpQkFzQkM7UUFyQkcsSUFBSSxPQUFPLEdBQUcsSUFBSSxjQUFPLENBQUMsRUFBRSxjQUFjLEVBQUUsbUNBQW1DLEVBQUUsQ0FBQyxDQUFDO1FBQ25GLElBQUksSUFBSSxHQUFHLElBQUksc0JBQWUsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFlB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QUFhLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDeEMsMEhBQTBIO2dCQUN2SCxDQUFDO2dCQUVELE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsd0JBQXdCLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFOUYsQ0FBQztTQUNILENBQUMsQ0FBQztJQUdKLENBQUM7SUFBQSxDQUFDO0lBdEhPLGtCQUFrQjtRQUQ5QixpQkFBVSxFQUFFO3lDQW1CaUIsV0FBSTtPQWxCckIsa0JBQWtCLENBd0g5QjtJQUFELHlCQUFDO0NBQUEsQUF4SEQsSUF3SEM7QUF4SFksZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCJcbmltcG9ydCB7IEh0dHAsIFJlc3BvbnNlLCBIZWFkZXJzIH0gZnJvbSBcIkBhbmd1bGFyL2h0dHBcIjtcbmltcG9ydCB7IFVSTFNlYXJjaFBhcmFtcyB9IGZyb20gXCJAYW5ndWxhci9odHRwXCJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvJztcbmltcG9ydCB7IEFwcG9pbnRtZW50IH0gZnJvbSBcIi4vYXBwb2ludG1lbnQubW9kZWxcIjtcbmltcG9ydCAqIGFzIFRvYXN0IGZyb20gXCJuYXRpdmVzY3JpcHQtdG9hc3RcIjtcbmltcG9ydCAqIGFzIGFwcGxpY2F0aW9uIGZyb20gJ2FwcGxpY2F0aW9uJ1xuaW1wb3J0IHsgTG9vcEFwcG9pbnRtZW50IH0gZnJvbSBcIi4vbG9vcC9sb29wLWFwcG9pbnRtZW50Lm1vZGVsXCI7XG5cbmRlY2xhcmUgbGV0IGFuZHJvaWQ6IGFueVxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcG9pbnRtZW50U2VydmljZSB7XG4gICAgcHJpdmF0ZSB1cmwgPSBcImh0dHBzOi8vdG9vbHMuYnJhbmRpbnN0aXR1dGUuY29tL3dzYmkvYmltb2JpbGUuYXNteC9cIlxuICAgIHByaXZhdGUgdXJsR2V0QXBwb2ludG1lbnRzID0gXCJnZXRBcHBvaW50bWVudHNcIlxuICAgIHByaXZhdGUgdXJsU2V0R2VvTG9jYXRpb24gPSBcImFkZEdlb0xvY2F0aW9uXCJcbiAgICBwcml2YXRlIGdldEV4cGVuc2VzQnlBcHBJZCA9IFwiZ2V0RXhwZW5zZXNCeUFwcG9pbnRtZW50SWRcIlxuICAgIHByaXZhdGUgcGhvbmVOdW1iZXI6IE9ic2VydmFibGU8YW55PjtcblxuICAgIHB1YmxpYyBhcHBvaW50bWVudHM6IE9ic2VydmFibGU8QXBwb2ludG1lbnRbXT47XG4gICAgcHJpdmF0ZSBfYXBwb2ludG1lbnRzID0gPEJlaGF2aW9yU3ViamVjdDxBcHBvaW50bWVudFtdPj5uZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgICBwcml2YXRlIGRhdGFTdG9yZToge1xuICAgICAgICBhcHBvaW50bWVudHM6IEFwcG9pbnRtZW50W11cbiAgICB9O1xuICAgIC8vIHByaXZhdGUgbGF0aXR1ZGUgPSAyNS43NzMzMzg7XG4gICAgLy8gcHJpdmF0ZSBsb25naXR1ZGUgPSAtODAuMTkwMDcyO1xuICAgIHByaXZhdGUgbW9udGhOYW1lcyA9IFtcIkphblwiLCBcIkZlYnJcIiwgXCJNYXJcIiwgXCJBcHJcIiwgXCJNYXlcIiwgXCJKdW5cIixcbiAgICAgICAgXCJKdWxcIiwgXCJBdWdcIiwgXCJTZXBcIiwgXCJPY3RcIiwgXCJOb3ZcIiwgXCJEZWNcIlxuICAgIF07XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHApIHtcbiAgICAgICAgdGhpcy5fYXBwb2ludG1lbnRzID0gPEJlaGF2aW9yU3ViamVjdDxBcHBvaW50bWVudFtdPj5uZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgICAgICAgdGhpcy5hcHBvaW50bWVudHMgPSB0aGlzLl9hcHBvaW50bWVudHMuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgZ2V0QXBwb2ludG1lbnRzKGRhdGU6IHN0cmluZyk6IE9ic2VydmFibGU8QXJyYXk8QXBwb2ludG1lbnQ+PiB7XG4gICAgICAgIGxldCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoeyAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgfSk7XG4gICAgICAgIGxldCBib2R5ID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpO1xuICAgICAgICBib2R5LnNldCgncGhvbmVJZCcsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdwaG9uZU51bWJlcicpKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWRUeXBlJywgXCIxXCIpO1xuICAgICAgICBib2R5LnNldCgnc2VsRGF0ZScsIGRhdGUpO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy51cmwgKyB0aGlzLnVybEdldEFwcG9pbnRtZW50cywgYm9keS50b1N0cmluZygpLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSkubWFwKHJlcyA9PiB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IHJlcy5qc29uKCk7XG4gICAgICAgICAgICByZXMuanNvbigpLm1hcCgob2JqOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZGF0ZVRpbWUgPSBuZXcgRGF0ZShvYmouQXBwRGF0ZSk7XG4gICAgICAgICAgICAgICAgdmFyIGhvdXJzID0gb2JqLkFwcERhdGUuc3BsaXQoJ1QnKVsxXS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIHZhciB0aW1lID0gaG91cnMudG9TdHJpbmcoKS5tYXRjaCAoL14oWzAxXVxcZHwyWzAtM10pKDopKFswLTVdXFxkKSg6WzAtNV1cXGQpPyQvKSB8fCBbb2JqLkFwcERhdGVdOyAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgIGlmICh0aW1lLmxlbmd0aCA+IDEpIHsgLy8gSWYgdGltZSBmb3JtYXQgY29ycmVjdFxuICAgICAgICAgICAgICAgICAgICB0aW1lID0gdGltZS5zbGljZSAoMSk7ICAvLyBSZW1vdmUgZnVsbCBzdHJpbmcgbWF0Y2ggdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgdGltZVs1XSA9ICt0aW1lWzBdIDwgMTIgPyAnQU0nIDogJ1BNJzsgLy8gU2V0IEFNL1BNXG4gICAgICAgICAgICAgICAgICAgIHRpbWVbMF0gPSArdGltZVswXSAlIDEyIHx8IDEyOyAvLyBBZGp1c3QgaG91cnNcbiAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBkYXRlVGltZS5nZXREYXRlKCkudG9TdHJpbmcoKSArICcsJyArIHRoaXMubW9udGhOYW1lc1tkYXRlVGltZS5nZXRNb250aCgpXS50b1N0cmluZygpICsnLScrICB0aW1lLmpvaW4gKCcnKTtcbiAgICAgICAgICAgICAgICBvYmouQXBwRGF0ZSA9IHRlbXA7XG4gICAgICAgICAgICB9KTsgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldEFwcG9pbnRtZW50TG9jYXRpb24oYXBwb2ludG1lbnRBZGRyZXNzKTogT2JzZXJ2YWJsZTxBcnJheTxBcHBvaW50bWVudD4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoXCJodHRwOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9nZW9jb2RlL2pzb24/YWRkcmVzcz1cIiArIGFwcG9pbnRtZW50QWRkcmVzcykubWFwKHJlcyA9PiByZXMuanNvbigpKTtcbiAgICB9XG5cbiAgICBzZXRHZW9Mb2NhdGlvbihsb2NhdGlvbjogYW55LCBhcHBvaW50bWVudDogQXBwb2ludG1lbnQpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBsZXQgZGF0ZVRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQgZGF0ZWFob3JhID0gZGF0ZVRpbWUuZ2V0RnVsbFllYXIoKS50b1N0cmluZygpICsgJy0nICsgKGRhdGVUaW1lLmdldE1vbnRoKCkrMSkudG9TdHJpbmcoKSArICctJyArIGRhdGVUaW1lLmdldERhdGUoKS50b1N0cmluZygpICsgJyAnICtcbiAgICAgICAgICAgICsgZGF0ZVRpbWUuZ2V0SG91cnMoKS50b1N0cmluZygpICsgJzonICsgZGF0ZVRpbWUuZ2V0TWludXRlcygpLnRvU3RyaW5nKCkgKyAnOicgKyBkYXRlVGltZS5nZXRTZWNvbmRzKCkudG9TdHJpbmcoKTtcbiAgICAgICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7XG4gICAgICAgIGNvbnN0IGJvZHkgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG4gICAgICAgIGJvZHkuc2V0KCdwaG9uZUlkJywgbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Bob25lTnVtYmVyJykpO1xuICAgICAgICBib2R5LnNldCgncGhvbmVJZFR5cGUnLCBcIjFcIik7XG4gICAgICAgIGJvZHkuc2V0KCdnZW9EYXRlJywgZGF0ZWFob3JhKTtcbiAgICAgICAgYm9keS5zZXQoJ2FwcElkJywgYXBwb2ludG1lbnQuQXBwSWQudG9TdHJpbmcoKSk7XG4gICAgICAgIGJvZHkuc2V0KCdnZW9MYXRpdHVkZScsIGxvY2F0aW9uLmxhdGl0dWRlLnRvU3RyaW5nKCkpO1xuICAgICAgICBib2R5LnNldCgnZ2VvTG9uZ2l0dWRlJywgbG9jYXRpb24ubG9uZ2l0dWRlLnRvU3RyaW5nKCkpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh0aGlzLnVybCArICdhZGRHZW9Mb2NhdGlvbicsIGJvZHkudG9TdHJpbmcoKSwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XG4gICAgfVxuXG4gICAgc2F2ZUV4cGVuc2UoYXBwb2ludG1lbnQ6IEFwcG9pbnRtZW50LCBpbWFnZUJhc2U2NDogYW55LCByZWNUeXBlOiBzdHJpbmcsIHJlY1RvdGFsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBsZXQgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnIH0pO1xuICAgICAgICBjb25zdCBib2R5ID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpO1xuICAgICAgICBib2R5LnNldCgncGhvbmVJZCcsIGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdwaG9uZU51bWJlcicpKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWRUeXBlJywgXCIxXCIpO1xuICAgICAgICBib2R5LnNldCgnYXBwSWQnLCBhcHBvaW50bWVudC5BcHBJZC50b1N0cmluZygpKTtcbiAgICAgICAgLy8gYm9keS5zZXQoJ3JlY1R5cGUnLCByZWNUeXBlKTsgIHVzZSB3aGVuIHJlYWwgdmFsdWVzIGluIG51bWJlciBjb21lIGZyb20gZHJvcGRvd25cbiAgICAgICAgYm9keS5zZXQoJ3JlY1R5cGUnLCAnMScpO1xuICAgICAgICBib2R5LnNldCgncmVjVG90YWwnLCByZWNUb3RhbCk7XG4gICAgICAgIGJvZHkuc2V0KCdpbWdUeXBlJywgJ2Jhc2U2NCcpO1xuICAgICAgICBib2R5LnNldCgnaW1nJywgaW1hZ2VCYXNlNjQpO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy51cmwgKyAnYWRkQXBwUmVjZWlwdFN0cmluZycsIGJvZHkudG9TdHJpbmcoKSwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pLm1hcChyZXMgPT4ge1xuICAgICAgICAgICAgcmVzLmpzb24oKTtcbiAgICAgICAgICAgIGltYWdlQmFzZTY0ID0gbnVsbDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0RXhwZW5zZXNCeUFwcG9pbnRtZW50SWQoYXBwaWQ6IHN0cmluZykge1xuICAgICAgICBsZXQgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHsgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnIH0pO1xuICAgICAgICBsZXQgYm9keSA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoKTtcbiAgICAgICAgYm9keS5zZXQoJ3Bob25lSWQnLCBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncGhvbmVOdW1iZXInKSk7XG4gICAgICAgIGJvZHkuc2V0KCdwaG9uZUlkVHlwZScsIFwiMVwiKTtcbiAgICAgICAgYm9keS5zZXQoJ2FwcGlkJywgYXBwaWQpO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodGhpcy51cmwgKyAnZ2V0RXhwZW5zZXNCeUFwcG9pbnRtZW50SWQnLCBib2R5LnRvU3RyaW5nKCksIHsgaGVhZGVyczogaGVhZGVycyB9KS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xuICAgIH1cblxuXG4gICAgXG4gICAgdGVzdFNlcnZpY2UoKXtcbiAgICAgICAgXG5cbiAgICBhbmRyb2lkLm5hdGl2ZUFwcC5JbnRlbnRTZXJ2aWNlLmV4dGVuZChcImNvbS50bnMubm90aWZpY2F0aW9ucy5Ob3RpZmljYXRpb25JbnRlbnRTZXJ2aWNlXCIgXG4gICAgLyogZ2l2ZSB5b3VyIGNsYXNzIGEgdmFsaWQgbmFtZSBhcyBpdCB3aWxsIG5lZWQgdG8gYmUgZGVjbGFyZWQgaW4gdGhlIEFuZHJvaWRNYW5pZmVzdCBsYXRlciAqLywge1xuICAgICAgICBvbkhhbmRsZUludGVudDogZnVuY3Rpb24gKGludGVudCkge1xuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGludGVudC5nZXRBY3Rpb24oKTtcbiAgICAgICAgICAgIGlmIChcIkFDVElPTl9TVEFSVFwiID09IGFjdGlvbikge1xuICAgICAgICAgICAgICAgIC8vIHBvc3ROb3RpZmljYXRpb24oKTtcbiAgICAgICAgICAgICAgICBUb2FzdC5tYWtlVGV4dChcIkFjdGlvbiBTdGFydGVkIDopXCIsIFwibG9uZ1wiKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBhbmRyb2lkLmNvbnRleHQ7XG4gICAgICAgICAgICAgICAgdmFyIGJ1aWxkZXIgPSBuZXcgYW5kcm9pZC5uYXRpdmVBcHAuTm90aWZpY2F0aW9uLkJ1aWxkZXIoY29udGV4dCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKFwiQUNUSU9OX1NUT1BcIiA9PSBhY3Rpb24pIHtcbiAgICAgICAgIC8qIGdldCB0aGUgc3lzdGVtIGFsYXJtIG1hbmFnZXIgYW5kIGNhbmNlbCBhbGwgcGVuZGluZyBhbGFybXMsIHdoaWNoIHdpbGwgc3RvcCB0aGUgc2VydmljZSBmcm9tIGV4ZWN1dGluZyBwZXJpb2RpY2FsbHkgICovXG4gICAgICAgICAgICB9XG4gICAgICAgICBcbiAgICAgICAgICAgIGFuZHJvaWQuY29udGV4dC5zdXBwb3J0LnY0LmNvbnRlbnQuV2FrZWZ1bEJyb2FkY2FzdFJlY2VpdmVyLmNvbXBsZXRlV2FrZWZ1bEludGVudChpbnRlbnQpO1xuICAgICAgXG4gICAgICAgIH1cbiAgICAgfSk7XG5cblxuICAgIH07XG5cbn1cblxuIl19